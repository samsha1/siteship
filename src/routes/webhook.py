# routes/webhook.py
from fastapi import APIRouter, Request, status
from fastapi.responses import JSONResponse
from src.handlers.telegram import send_message
from src.core.models import ModelClients
from src.handlers.supabase import save_html_to_storage
router = APIRouter()

@router.post("/telegram-webhook")
async def telegram_webhook(request: Request):
    """Handle incoming Telegram webhook requests."""
    payload = await request.json()

    chat_id = payload.get("message", {}).get("chat", {}).get("id")
    user_input = payload.get("message", {}).get("text", "")

    if not chat_id or not user_input:
        return {"ok": False, "reason": "Invalid payload"}

    get_model_instances =  ModelClients.get_instance()
    code = None
    if get_model_instances.gemini_client:
        # code = await get_model_instances.gemini_client.generate_website_code(user_input)
        code = get_static_response_to_save_gemini_call()
        
        if code:
            code = code.replace("```html", "").replace("```", "").strip()
            # call Supabase client to store the generated code
            supabase_client = get_model_instances.supabase_client
            
            sink_to_s3_and_get_public_url = await save_html_to_storage(
                supabase_client,
                user_id=str(chat_id),  # Use chat_id as user_id
                project_name="generated_website",
                html_code=code
            )
            # Store to memcached or database if needed for model memory with user metadata
            # For example, you can store the code in a table named 'generated_codes'
            #store file index.html file in storage and return the storage URL
            
            # can we snapshot the code (?)
            
            """Send the generated code back to the user via Telegram"""
            await send_message(chat_id, f"Please access your publsihed site here:\n\n{sink_to_s3_and_get_public_url}...")
            return JSONResponse(
                status_code=status.HTTP_200_OK,
                content={"success": True, "message": "Code generated and sent successfully!"}
            )  
        

    await send_message(chat_id, "Sorry, I couldn't generate the code for your request. Please try again later.")
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={"success": False, "message": "Message Failed to send"},
    )
    

def get_static_response_to_save_gemini_call():
    """
    Returns a static response to save Gemini call.
    This is a placeholder function for future use.
    """
    return '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Kathmandu Bakery - Organic Delights from the Himalayas</title>\n    <style>\n        /* General Styling */\n        :root {\n            --primary-color: #8B4513; /* SaddleBrown */\n            --secondary-color: #F5DEB3; /* Wheat */\n            --text-color: #333;\n            --light-bg: #FFF8E1; /* Light yellow/cream */\n            --white: #FFFFFF;\n            --font-family: \'Georgia\', serif;\n        }\n\n        * {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n            scroll-behavior: smooth;\n        }\n\n        body {\n            font-family: var(--font-family);\n            line-height: 1.6;\n            color: var(--text-color);\n            background-color: var(--light-bg);\n        }\n\n        .container {\n            max-width: 1100px;\n            margin: 0 auto;\n            padding: 0 20px;\n        }\n\n        h1, h2, h3 {\n            color: var(--primary-color);\n            line-height: 1.2;\n            margin-bottom: 1rem;\n        }\n        \n        h2 {\n            text-align: center;\n            font-size: 2.5rem;\n            margin-bottom: 2rem;\n            text-transform: uppercase;\n            letter-spacing: 2px;\n        }\n\n        p {\n            margin-bottom: 1rem;\n        }\n\n        section {\n            padding: 60px 0;\n        }\n\n        /* Header & Navigation */\n        .header {\n            background-color: var(--white);\n            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);\n            position: sticky;\n            top: 0;\n            z-index: 1000;\n        }\n\n        .navbar {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 1rem 0;\n        }\n\n        .logo {\n            font-size: 1.8rem;\n            font-weight: bold;\n            color: var(--primary-color);\n            text-decoration: none;\n        }\n\n        .nav-links {\n            list-style: none;\n            display: flex;\n        }\n\n        .nav-links li {\n            padding-left: 25px;\n        }\n\n        .nav-links a {\n            text-decoration: none;\n            color: var(--primary-color);\n            font-weight: bold;\n            transition: color 0.3s ease;\n        }\n\n        .nav-links a:hover {\n            color: #c4621a;\n        }\n\n        /* Hamburger Menu for Mobile */\n        .hamburger {\n            display: none;\n            cursor: pointer;\n            flex-direction: column;\n            gap: 5px;\n        }\n\n        .hamburger .bar {\n            width: 25px;\n            height: 3px;\n            background-color: var(--primary-color);\n            transition: all 0.3s ease-in-out;\n        }\n\n        /* Hero Section */\n        .hero {\n            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(\'https://images.unsplash.com/photo-1555507036-ab1f4038808a?q=80&w=1974&auto=format&fit=crop\') no-repeat center center/cover;\n            color: var(--white);\n            height: 80vh;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            text-align: center;\n        }\n\n        .hero-content {\n            max-width: 700px;\n        }\n\n        .hero h1 {\n            font-size: 3.5rem;\n            color: var(--white);\n        }\n\n        .hero .tagline {\n            font-size: 1.5rem;\n            font-style: italic;\n            margin-top: 1rem;\n            color: var(--secondary-color);\n        }\n\n        /* About Section */\n        #about {\n            background-color: var(--white);\n        }\n        \n        .about-content {\n            display: flex;\n            align-items: center;\n            gap: 2rem;\n        }\n        \n        .about-text {\n            flex: 1;\n        }\n        \n        .about-image {\n            flex: 1;\n        }\n\n        .about-image img {\n            width: 100%;\n            border-radius: 10px;\n            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\n        }\n\n        /* Menu Section */\n        .menu-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n            gap: 2rem;\n        }\n\n        .menu-item {\n            background-color: var(--white);\n            border-radius: 8px;\n            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);\n            padding: 1.5rem;\n            text-align: center;\n            transition: transform 0.3s ease, box-shadow 0.3s ease;\n        }\n        \n        .menu-item:hover {\n            transform: translateY(-5px);\n            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);\n        }\n\n        .menu-item img {\n            width: 100%;\n            height: 200px;\n            object-fit: cover;\n            border-radius: 5px;\n            margin-bottom: 1rem;\n        }\n\n        .menu-item h3 {\n            margin-bottom: 0.5rem;\n        }\n\n        .menu-item .price {\n            font-weight: bold;\n            color: #556B2F; /* DarkOliveGreen */\n            font-size: 1.2rem;\n        }\n        \n        /* Contact Section */\n        #contact {\n            background-color: var(--secondary-color);\n        }\n        \n        .contact-content {\n            display: flex;\n            gap: 3rem;\n            background-color: var(--white);\n            padding: 2rem;\n            border-radius: 10px;\n            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\n        }\n        \n        .contact-info, .contact-form-container {\n            flex: 1;\n        }\n        \n        .contact-info h3, .contact-form-container h3 {\n             margin-top: 0;\n        }\n\n        .contact-info p {\n            margin-bottom: 1.5rem;\n            font-size: 1.1rem;\n        }\n\n        .contact-info i {\n            color: var(--primary-color);\n            margin-right: 10px;\n            width: 20px;\n        }\n\n        .contact-form input,\n        .contact-form textarea {\n            width: 100%;\n            padding: 10px;\n            margin-bottom: 1rem;\n            border: 1px solid #ddd;\n            border-radius: 5px;\n            font-family: var(--font-family);\n        }\n        \n        .contact-form button {\n            background: var(--primary-color);\n            color: var(--white);\n            border: none;\n            padding: 12px 20px;\n            border-radius: 5px;\n            cursor: pointer;\n            font-size: 1rem;\n            font-weight: bold;\n            transition: background-color 0.3s ease;\n        }\n        \n        .contact-form button:hover {\n            background-color: #a0522d;\n        }\n\n        /* Footer */\n        .footer {\n            background-color: var(--primary-color);\n            color: var(--secondary-color);\n            text-align: center;\n            padding: 2rem 0;\n        }\n\n        .footer p {\n            margin: 0;\n        }\n\n        /* Responsive Design */\n        @media (max-width: 768px) {\n            .hero h1 {\n                font-size: 2.5rem;\n            }\n            .hero .tagline {\n                font-size: 1.2rem;\n            }\n            \n            .about-content, .contact-content {\n                flex-direction: column;\n            }\n\n            .nav-links {\n                display: none;\n                flex-direction: column;\n                width: 100%;\n                background-color: var(--white);\n                position: absolute;\n                top: 70px; /* Adjust based on header height */\n                left: 0;\n                text-align: center;\n                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);\n            }\n            \n            .nav-links.active {\n                display: flex;\n            }\n\n            .nav-links li {\n                padding: 1rem 0;\n                width: 100%;\n                border-top: 1px solid var(--light-bg);\n            }\n\n            .hamburger {\n                display: flex;\n            }\n            \n            .hamburger.active .bar:nth-child(2) {\n                opacity: 0;\n            }\n            .hamburger.active .bar:nth-child(1) {\n                transform: translateY(8px) rotate(45deg);\n            }\n            .hamburger.active .bar:nth-child(3) {\n                transform: translateY(-8px) rotate(-45deg);\n            }\n        }\n    </style>\n    <!-- Font Awesome for icons -->\n    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">\n</head>\n<body>\n\n    <header class="header">\n        <div class="container navbar">\n            <a href="#home" class="logo">Kathmandu Bakery</a>\n            <ul class="nav-links">\n                <li><a href="#home">Home</a></li>\n                <li><a href="#about">About</a></li>\n                <li><a href="#menu">Menu</a></li>\n                <li><a href="#contact">Contact</a></li>\n            </ul>\n            <div class="hamburger">\n                <span class="bar"></span>\n                <span class="bar"></span>\n                <span class="bar"></span>\n            </div>\n        </div>\n    </header>\n\n    <main>\n        <!-- Home Section -->\n        <section id="home" class="hero">\n            <div class="hero-content">\n                <h1>Welcome to Kathmandu Bakery</h1>\n                <p class="tagline">Bringing organic from the foothills of Himalaya since 1988.</p>\n            </div>\n        </section>\n\n        <!-- About Us Section -->\n        <section id="about">\n            <div class="container">\n                <h2>About Us</h2>\n                <div class="about-content">\n                    <div class="about-text">\n                        <h3>Our Story</h3>\n                        <p>Founded in 1988, Kathmandu Bakery has been a cherished part of the local community, nestled in the heart of the city. We started with a simple mission: to bake delicious, wholesome goods using traditional methods and the finest organic ingredients sourced directly from the Himalayan foothills. Our passion for quality and authenticity is baked into every loaf of bread, every pastry, and every cup of coffee we serve.</p>\n                        <p>We believe in the power of good food to bring people together. Our cozy space is designed to be a warm retreat from the bustling city, a place where friends can meet, families can celebrate, and individuals can find a moment of peace. Thank you for being a part of our journey.</p>\n                    </div>\n                    <div class="about-image">\n                        <img src="https://images.unsplash.com/photo-1598114631393-d5b41392728b?q=80&w=1935&auto=format&fit=crop" alt="Inside the bakery">\n                    </div>\n                </div>\n            </div>\n        </section>\n\n        <!-- Menu Section -->\n        <section id="menu">\n            <div class="container">\n                <h2>Our Menu</h2>\n                <div class="menu-grid">\n                    <!-- Item 1 -->\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1568051243851-f9b136146e97?q=80&w=1887&auto=format&fit=crop" alt="Croissant">\n                        <h3>Butter Croissant</h3>\n                        <p>Flaky, buttery, and baked to golden perfection.</p>\n                        <p class="price">Rs. 220</p>\n                    </div>\n                    <!-- Item 2 -->\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1578985545062-69928b1d9587?q=80&w=1987&auto=format&fit=crop" alt="Chocolate Cake">\n                        <h3>Dark Chocolate Cake</h3>\n                        <p>Rich, moist, and decadent chocolate delight.</p>\n                        <p class="price">Rs. 280</p>\n                    </div>\n                    <!-- Item 3 -->\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1551024601-bec78aea704b?q=80&w=1964&auto=format&fit=crop" alt="Muffin">\n                        <h3>Blueberry Muffin</h3>\n                        <p>Packed with fresh, organic blueberries.</p>\n                        <p class="price">Rs. 190</p>\n                    </div>\n                    <!-- Item 4 -->\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1506354666786-959d6d497f1a?q=80&w=2070&auto=format&fit=crop" alt="Sourdough Bread">\n                        <h3>Himalayan Sourdough</h3>\n                        <p>Artisanal sourdough bread with a crispy crust.</p>\n                        <p class="price">Rs. 250</p>\n                    </div>\n                    <!-- Item 5 -->\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1511920183353-3c9c35b6a71e?q=80&w=1887&auto=format&fit=crop" alt="Espresso">\n                        <h3>Organic Espresso</h3>\n                        <p>A rich and aromatic shot of pure coffee bliss.</p>\n                        <p class="price">Rs. 180</p>\n                    </div>\n                    <!-- Item 6 -->\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1497935586351-b67a49e012bf?q=80&w=2071&auto=format&fit=crop" alt="Cappuccino">\n                        <h3>Classic Cappuccino</h3>\n                        <p>Perfectly balanced with steamed milk and foam.</p>\n                        <p class="price">Rs. 250</p>\n                    </div>\n                </div>\n            </div>\n        </section>\n\n        <!-- Contact Section -->\n        <section id="contact">\n            <div class="container">\n                <h2>Contact Us</h2>\n                <div class="contact-content">\n                    <div class="contact-info">\n                        <h3>Get In Touch</h3>\n                        <p>We\'d love to hear from you! Whether it\'s for a special order, feedback, or just to say hello, feel free to reach out or visit us at our cozy corner in Kathmandu.</p>\n                        <p><i class="fas fa-map-marker-alt"></i>123 Bakery Street, Thamel, Kathmandu, Nepal</p>\n                        <p><i class="fas fa-phone"></i>+977 1 4412345</p>\n                        <p><i class="fas fa-envelope"></i>hello@kathmandubakery.com</p>\n                        <h3>Opening Hours</h3>\n                        <p><i class="fas fa-clock"></i>Sun - Sat: 8:00 AM - 9:00 PM</p>\n                    </div>\n                    <div class="contact-form-container">\n                        <h3>Send a Message</h3>\n                        <form class="contact-form">\n                            <input type="text" name="name" placeholder="Your Name" required>\n                            <input type="email" name="email" placeholder="Your Email" required>\n                            <textarea name="message" rows="6" placeholder="Your Message" required></textarea>\n                            <button type="submit">Send Message</button>\n                        </form>\n                    </div>\n                </div>\n            </div>\n        </section>\n    </main>\n\n    <footer class="footer">\n        <div class="container">\n            <p>&copy; 2024 Kathmandu Bakery. All Rights Reserved.</p>\n        </div>\n    </footer>\n\n    <script>\n        const hamburger = document.querySelector(\'.hamburger\');\n        const navLinks = document.querySelector(\'.nav-links\');\n\n        hamburger.addEventListener(\'click\', () => {\n            hamburger.classList.toggle(\'active\');\n            navLinks.classList.toggle(\'active\');\n        });\n\n        document.querySelectorAll(\'.nav-links a\').forEach(link => {\n            link.addEventListener(\'click\', () => {\n                if (navLinks.classList.contains(\'active\')) {\n                    hamburger.classList.remove(\'active\');\n                    navLinks.classList.remove(\'active\');\n                }\n            });\n        });\n\n        // Prevent form submission for this demo\n        const contactForm = document.querySelector(\'.contact-form\');\n        contactForm.addEventListener(\'submit\', function(e) {\n            e.preventDefault();\n            alert(\'Thank you for your message! (This is a demo)\');\n            this.reset();\n        });\n    </script>\n</body>\n</html>\n```'
