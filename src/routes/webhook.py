# routes/webhook.py
from fastapi import APIRouter, Request, status
from fastapi.responses import JSONResponse
from src.handlers.telegram import send_message
from src.core.models import ModelClients
from src.handlers.supabase import save_html_to_storage
from src.utils.parser import extract_and_zip_code
router = APIRouter()

@router.post("/telegram-webhook")
async def telegram_webhook(request: Request):
    """Handle incoming Telegram webhook requests."""
    payload = await request.json()

    chat_id = payload.get("message", {}).get("chat", {}).get("id")
    user_input = payload.get("message", {}).get("text", "")

    if not chat_id or not user_input:
        return {"ok": False, "reason": "Invalid payload"}

    get_model_instances =  ModelClients.get_instance()
    code = None
    if get_model_instances.gemini_client:
        # code = await get_model_instances.gemini_client.generate_website_code(user_input)
        code = get_static_response_to_save_gemini_call()
        
        if code:
            # code = code.replace("```html", "").replace("```", "").strip()
            zip_file_path = await extract_and_zip_code(model_response=code, user_id=str(chat_id))

            # call Supabase client to store the generated code
            supabase_client = get_model_instances.supabase_client
            
            sink_to_s3_and_get_public_url = await save_html_to_storage(
                supabase_client,
                user_id=str(chat_id),  # Use chat_id as user_id
                project_name="generated_website",
                file_path=zip_file_path
            )
            # Store to memcached or database if needed for model memory with user metadata
            # For example, you can store the code in a table named 'generated_codes'
            #store file index.html file in storage and return the storage URL
            
            # can we snapshot the code (?)
            
            """Send the generated code back to the user via Telegram"""
            await send_message(chat_id, f"Please access your publsihed site here:\n\n{sink_to_s3_and_get_public_url}...")
            return JSONResponse(
                status_code=status.HTTP_200_OK,
                content={"success": True, "message": "Code generated and sent successfully!"}
            )  
        

    await send_message(chat_id, "Sorry, I couldn't generate the code for your request. Please try again later.")
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={"success": False, "message": "Message Failed to send"},
    )
    

def get_static_response_to_save_gemini_call():
    """
    Returns a static response to save Gemini call.
    This is a placeholder function for future use.
    """
    return '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Himalayan Bakery - Kathmandu</title>\n</head>\n<body>\n\n    <header>\n        <nav>\n            <div class="logo">\n                <a href="#home">Himalayan Bakery</a>\n            </div>\n            <ul class="nav-links">\n                <li><a href="#home">Home</a></li>\n                <li><a href="#about">About</a></li>\n                <li><a href="#menu">Menu</a></li>\n                <li><a href="#contact">Contact</a></li>\n            </ul>\n            <div class="hamburger">\n                <div class="line"></div>\n                <div class="line"></div>\n                <div class="line"></div>\n            </div>\n        </nav>\n    </header>\n\n    <main>\n        <section id="home" class="hero-section">\n            <div class="hero-content">\n                <h1>Welcome to Himalayan Bakery</h1>\n                <p>Bringing organic from the foothills of Himalaya since 1988.</p>\n                <a href="#menu" class="cta-button">View Our Menu</a>\n            </div>\n        </section>\n\n        <section id="about" class="content-section">\n            <div class="container">\n                <h2>About Us</h2>\n                <div class="about-content">\n                    <img src="https://images.unsplash.com/photo-1598373182133-52452f741796?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600" alt="Inside the bakery">\n                    <p>Nestled in the heart of Kathmandu, Himalayan Bakery has been serving freshly baked goods since 1988. Our journey began with a simple mission: to bring the authentic, organic flavors from the Himalayan foothills to our community. We use locally sourced ingredients to create delicious pastries, breads, and cakes, all made with love and a touch of tradition. We believe in quality, community, and the simple joy of a warm, freshly baked treat.</p>\n                </div>\n            </div>\n        </section>\n\n        <section id="menu" class="content-section">\n            <div class="container">\n                <h2>Our Menu</h2>\n                <div class="menu-grid">\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1555507036-ab1f4038808a?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=400" alt="Croissant">\n                        <h3>Butter Croissant</h3>\n                        <p>Flaky and buttery, a classic favorite.</p>\n                        <span class="price">Rs. 180</span>\n                    </div>\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1571362943423-96f1fa44a377?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=400" alt="Chocolate Cake">\n                        <h3>Chocolate Fudge Cake</h3>\n                        <p>Rich and decadent, for the true chocolate lover.</p>\n                        <span class="price">Rs. 250</span>\n                    </div>\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1588195538326-c5b1e9f80a1b?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=400" alt="Muffins">\n                        <h3>Blueberry Muffin</h3>\n                        <p>Moist and bursting with fresh blueberries.</p>\n                        <span class="price">Rs. 150</span>\n                    </div>\n                     <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1509371942342-9df7f29013f9?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=400" alt="Sourdough Bread">\n                        <h3>Himalayan Sourdough</h3>\n                        <p>Artisanal bread with a tangy flavor.</p>\n                        <span class="price">Rs. 280</span>\n                    </div>\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1511920183353-34e85a7420e9?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=400" alt="Americano Coffee">\n                        <h3>Americano</h3>\n                        <p>Rich espresso shots topped with hot water.</p>\n                        <span class="price">Rs. 200</span>\n                    </div>\n                    <div class="menu-item">\n                        <img src="https://images.unsplash.com/photo-1579954115545-a95591f28bfc?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=400" alt="Latte Coffee">\n                        <h3>Cafe Latte</h3>\n                        <p>Espresso with steamed milk and a touch of foam.</p>\n                        <span class="price">Rs. 260</span>\n                    </div>\n                </div>\n            </div>\n        </section>\n\n        <section id="contact" class="content-section">\n            <div class="container">\n                <h2>Contact Us</h2>\n                <div class="contact-content">\n                    <div class="contact-info">\n                        <h3>Visit Our Bakery</h3>\n                        <p>123 Bakery Street, Thamel<br>Kathmandu, Nepal</p>\n                        \n                        <h3>Opening Hours</h3>\n                        <p>Sunday - Saturday<br>8:00 AM - 9:00 PM</p>\n\n                        <h3>Get in Touch</h3>\n                        <p>Phone: +977-9800000000<br>Email: info@himalayanbakery.com.np</p>\n                    </div>\n                    <div class="contact-map">\n                         <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d56516.27776840787!2d85.2911132962391!3d27.70903193375363!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x39eb198a307baabf%3A0x142b31e0129b2366!2sKathmandu%2C%20Nepal!5e0!3m2!1sen!2sus!4v1695578795995!5m2!1sen!2sus" width="100%" height="350" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>\n                    </div>\n                </div>\n            </div>\n        </section>\n    </main>\n\n    <footer>\n        <p>&copy; 2024 Himalayan Bakery. All Rights Reserved.</p>\n    </footer>\n\n</body>\n</html>\n```\n```css\n/* --- Global Styles --- */\n:root {\n    --primary-color: #6a4f4b; /* Brown */\n    --secondary-color: #f4e8c1; /* Cream */\n    --accent-color: #a47551; /* Lighter brown */\n    --text-color: #3e3636;\n    --bg-color: #fff9f0;\n    --header-height: 70px;\n    scroll-behavior: smooth;\n    scroll-padding-top: var(--header-height);\n}\n\n* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;\n    line-height: 1.6;\n    background-color: var(--bg-color);\n    color: var(--text-color);\n}\n\n.container {\n    max-width: 1100px;\n    margin: 0 auto;\n    padding: 0 20px;\n}\n\nimg {\n    max-width: 100%;\n    height: auto;\n    display: block;\n}\n\n/* --- Header & Navigation --- */\nheader {\n    background-color: var(--primary-color);\n    color: white;\n    position: fixed;\n    width: 100%;\n    top: 0;\n    z-index: 1000;\n    height: var(--header-height);\n    box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\nnav {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    max-width: 1200px;\n    margin: 0 auto;\n    padding: 0 20px;\n    height: 100%;\n}\n\n.logo a {\n    color: white;\n    text-decoration: none;\n    font-size: 1.5rem;\n    font-weight: bold;\n}\n\n.nav-links {\n    list-style: none;\n    display: flex;\n}\n\n.nav-links li {\n    padding: 0 15px;\n}\n\n.nav-links a {\n    color: white;\n    text-decoration: none;\n    font-size: 1rem;\n    transition: color 0.3s ease;\n}\n\n.nav-links a:hover {\n    color: var(--secondary-color);\n}\n\n.hamburger {\n    display: none;\n    cursor: pointer;\n}\n\n.hamburger .line {\n    width: 25px;\n    height: 3px;\n    background-color: white;\n    margin: 5px;\n    transition: all 0.3s ease;\n}\n\n/* --- Hero Section --- */\n.hero-section {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    text-align: center;\n    height: 100vh;\n    min-height: 450px;\n    color: white;\n    background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(\'https://images.unsplash.com/photo-1509735874202-a1a74a141334?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200\') no-repeat center center/cover;\n    padding-top: var(--header-height);\n}\n\n.hero-content h1 {\n    font-size: 3rem;\n    margin-bottom: 1rem;\n}\n\n.hero-content p {\n    font-size: 1.25rem;\n    margin-bottom: 2rem;\n    color: var(--secondary-color);\n}\n\n.cta-button {\n    background-color: var(--accent-color);\n    color: white;\n    padding: 12px 25px;\n    text-decoration: none;\n    border-radius: 5px;\n    font-size: 1.1rem;\n    transition: background-color 0.3s ease;\n}\n\n.cta-button:hover {\n    background-color: var(--primary-color);\n}\n\n/* --- Content Sections --- */\n.content-section {\n    padding: 60px 0;\n}\n\n.content-section:nth-child(even) {\n    background-color: white;\n}\n\n.content-section h2 {\n    text-align: center;\n    font-size: 2.5rem;\n    margin-bottom: 40px;\n    color: var(--primary-color);\n}\n\n/* --- About Section --- */\n.about-content {\n    display: flex;\n    align-items: center;\n    gap: 40px;\n}\n\n.about-content img {\n    flex: 1;\n    max-width: 400px;\n    border-radius: 8px;\n    box-shadow: 0 4px 15px rgba(0,0,0,0.1);\n}\n\n.about-content p {\n    flex: 1.5;\n    font-size: 1.1rem;\n}\n\n/* --- Menu Section --- */\n.menu-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: 30px;\n}\n\n.menu-item {\n    background-color: white;\n    border-radius: 8px;\n    box-shadow: 0 4px 15px rgba(0,0,0,0.08);\n    overflow: hidden;\n    text-align: center;\n    transition: transform 0.3s ease, box-shadow 0.3s ease;\n}\n\n.menu-item:hover {\n    transform: translateY(-5px);\n    box-shadow: 0 8px 20px rgba(0,0,0,0.12);\n}\n\n.menu-item img {\n    width: 100%;\n    height: 200px;\n    object-fit: cover;\n}\n\n.menu-item h3 {\n    margin: 15px 0 10px;\n    color: var(--primary-color);\n}\n\n.menu-item p {\n    padding: 0 15px;\n    font-size: 0.9rem;\n    min-height: 45px;\n}\n\n.price {\n    display: block;\n    font-weight: bold;\n    color: var(--accent-color);\n    font-size: 1.2rem;\n    margin: 15px 0;\n}\n\n/* --- Contact Section --- */\n.contact-content {\n    display: flex;\n    gap: 40px;\n}\n\n.contact-info, .contact-map {\n    flex: 1;\n}\n\n.contact-info h3 {\n    color: var(--primary-color);\n    margin-top: 20px;\n    margin-bottom: 10px;\n}\n.contact-info h3:first-child {\n    margin-top: 0;\n}\n\n.contact-map iframe {\n    border-radius: 8px;\n}\n\n/* --- Footer --- */\nfooter {\n    background-color: var(--primary-color);\n    color: var(--secondary-color);\n    text-align: center;\n    padding: 20px;\n}\n\n/* --- Responsive Design --- */\n@media (max-width: 768px) {\n    .nav-links {\n        position: fixed;\n        right: -100%;\n        top: var(--header-height);\n        background-color: var(--primary-color);\n        flex-direction: column;\n        width: 60%;\n        height: calc(100vh - var(--header-height));\n        align-items: center;\n        transition: right 0.5s ease-in;\n        padding-top: 40px;\n    }\n\n    .nav-links li {\n        padding: 20px 0;\n    }\n    \n    .nav-links.nav-active {\n        right: 0;\n    }\n\n    .hamburger {\n        display: block;\n    }\n    \n    .toggle .line1 {\n        transform: rotate(-45deg) translate(-5px, 6px);\n    }\n    .toggle .line2 {\n        opacity: 0;\n    }\n    .toggle .line3 {\n        transform: rotate(45deg) translate(-5px, -6px);\n    }\n    \n    .hero-content h1 {\n        font-size: 2.5rem;\n    }\n\n    .about-content, .contact-content {\n        flex-direction: column;\n    }\n\n    .about-content img {\n        max-width: 100%;\n    }\n}\n```\n```javascript\ndocument.addEventListener(\'DOMContentLoaded\', () => {\n    const hamburger = document.querySelector(\'.hamburger\');\n    const navLinks = document.querySelector(\'.nav-links\');\n    const links = document.querySelectorAll(\'.nav-links li a\');\n\n    // Toggle mobile navigation\n    hamburger.addEventListener(\'click\', () => {\n        navLinks.classList.toggle(\'nav-active\');\n        hamburger.classList.toggle(\'toggle\');\n    });\n\n    // Close mobile nav when a link is clicked\n    links.forEach(link => {\n        link.addEventListener(\'click\', () => {\n            if (navLinks.classList.contains(\'nav-active\')) {\n                navLinks.classList.remove(\'nav-active\');\n                hamburger.classList.remove(\'toggle\');\n            }\n        });\n    });\n});\n```'